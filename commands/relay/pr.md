---
name: relay:pr
description: Create a pull request from completed ticket work
argument-hint: [ticket-id]
allowed-tools:
  - Read
  - Write
  - Bash
  - Glob
  - Grep
  - AskUserQuestion
  - mcp__jira__add_comment
  - mcp__github__create_comment
  - mcp__azure_devops__update_work_item
---

<objective>
Create a pull request from completed ticket work with auto-generated title and description based on ticket artifacts (ANALYSIS.md, SUMMARY.md, VERIFICATION.md).

No agents spawned — orchestration only.
</objective>

<context>
@.relay/config.json
@.relay/STATE.md
Ticket ID: $ARGUMENTS
</context>

<process>

## 0. Pre-flight

```bash
test -f .relay/config.json && echo "config exists" || echo "no config"
```

If no config: suggest `/relay:setup` and STOP.

Read code hosting config from `.relay/config.json`:
- `code_hosting.type`: `"github"` | `"gitlab"` | `"bitbucket"` | `null`
- `code_hosting.cli`: `"gh"` | `"glab"` | `null`

If `code_hosting.type` is null: suggest running `/relay:setup` to configure code hosting and STOP.

Check CLI availability and auth for the configured provider:

**If code_hosting.type == "github":**
```bash
command -v gh >/dev/null 2>&1 && echo "gh available" || echo "gh missing"
gh auth status 2>&1 | head -1
```

**Else if code_hosting.type == "gitlab":**
```bash
command -v glab >/dev/null 2>&1 && echo "glab available" || echo "glab missing"
glab auth status 2>&1 | head -1
```

**Else (bitbucket/other):**
Warn that automated PR creation is not available for this hosting provider. Offer to generate the PR description locally and STOP.

If CLI not available or not authenticated: report requirement and STOP.

## 1. Resolve Ticket ID

**If $ARGUMENTS provided:** Use as ticket ID.

**If no arguments:** Try to detect from STATE.md active ticket or current branch:

```bash
# Try active ticket from STATE.md
grep -oE 'Active.*: [A-Z]+-[0-9]+' .relay/STATE.md 2>/dev/null | grep -oE '[A-Z]+-[0-9]+' | head -1

# Try current branch name
git branch --show-current | grep -oE '[A-Z]+-[0-9]+' | head -1
```

If no ticket ID resolved:
```
AskUserQuestion(
  header: "Ticket",
  question: "Which ticket's work should this PR cover?",
  options: [
    { label: "Enter ID", description: "Type a ticket ID (e.g., PROJ-123)" },
    { label: "Browse tickets", description: "See tickets with existing work" }
  ]
)
```

## 2. Gather Context

Read ticket artifacts:

```bash
test -f .relay/tickets/${TICKET_ID}/ANALYSIS.md && echo "analysis exists"
test -f .relay/tickets/${TICKET_ID}/SUMMARY.md && echo "summary exists"
test -f .relay/tickets/${TICKET_ID}/VERIFICATION.md && echo "verification exists"
```

Read available artifacts and extract:
- **From ANALYSIS.md:** Ticket title, type, acceptance criteria
- **From SUMMARY.md:** What was implemented, key decisions
- **From VERIFICATION.md:** Pass/fail status, coverage

Get git context:

```bash
# Diff stat against main/master
BASE_BRANCH=$(git remote show origin 2>/dev/null | grep 'HEAD branch' | sed 's/.*: //')
BASE_BRANCH=${BASE_BRANCH:-main}

git diff ${BASE_BRANCH}...HEAD --stat
git log ${BASE_BRANCH}...HEAD --oneline
```

## 3. Generate PR Content

**Title format:** `${TICKET_ID}: ${ticket_title}`

**Body format:**

```markdown
## Summary

{2-3 bullet points from SUMMARY.md describing what was done}

## Changes

{diff stat summary — files changed, insertions, deletions}

## Verification

{pass/fail status from VERIFICATION.md}
{list acceptance criteria with check marks}

## Commits

{list of commits from git log}

---

Ticket: ${TICKET_ID}
Generated by [Relay](https://github.com/ibnyusrat/relay)
```

## 4. Preview and Confirm

Display the generated PR:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 Relay ► PR PREVIEW — ${TICKET_ID}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Title: ${PR_TITLE}

${PR_BODY}
```

```
AskUserQuestion(
  header: "Create PR",
  question: "How would you like to proceed?",
  options: [
    { label: "Create PR", description: "Push branch and create pull request" },
    { label: "Edit title", description: "Modify the PR title before creating" },
    { label: "Edit body", description: "Modify the PR description before creating" },
    { label: "Cancel", description: "Don't create a PR" }
  ]
)
```

If "Edit title": ask for new title, then re-preview.
If "Edit body": ask for changes, then re-preview.
If "Cancel": STOP.

## 5. Push and Create PR/MR

```bash
# Push branch
CURRENT_BRANCH=$(git branch --show-current)
git push -u origin "${CURRENT_BRANCH}"
```

**If code_hosting.type == "github":**
```bash
gh pr create --title "${PR_TITLE}" --body "${PR_BODY}" --base "${BASE_BRANCH}"
```

**Else if code_hosting.type == "gitlab":**
```bash
glab mr create --title "${PR_TITLE}" --description "${PR_BODY}" --target-branch "${BASE_BRANCH}"
```

**Else:**
Report that automated PR creation is not available. Display the generated title and body so the user can create the PR manually.

Capture PR/MR URL from output.

## 6. Update State

Update STATE.md with PR link:

**If code_hosting.type == "github":**
```bash
PR_URL=$(gh pr view --json url --jq '.url')
```

**Else if code_hosting.type == "gitlab":**
```bash
PR_URL=$(glab mr view --output json | jq -r '.web_url')
```

**Else:**
Skip automated URL retrieval; use the URL captured from Step 5 output if available.

## 7. Optional: Post PR Link to Ticket System

If integration is configured:

```
AskUserQuestion(
  header: "Sync",
  question: "Post PR link back to ${TICKET_ID}?",
  options: [
    { label: "Post link", description: "Add PR URL as comment on the ticket" },
    { label: "Skip", description: "Don't update the external ticket" }
  ]
)
```

If "Post link": use appropriate MCP tool to add comment with PR URL.

## 8. Completion

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 Relay ► PR CREATED — ${TICKET_ID}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

PR: ${PR_URL}
Title: ${PR_TITLE}
Branch: ${CURRENT_BRANCH} → ${BASE_BRANCH}

## Next Steps

- Review the PR at ${PR_URL}
- `/relay:tickets` — pick another ticket
- `/relay:work <id>` — start next ticket
```

</process>

<success_criteria>
- [ ] Code hosting provider read from config
- [ ] Ticket ID resolved (from argument, STATE.md, or branch)
- [ ] Ticket artifacts read for context
- [ ] PR/MR title and body generated from artifacts
- [ ] User previewed and approved content
- [ ] Branch pushed to remote
- [ ] PR/MR created via provider-appropriate CLI (or description displayed for manual creation)
- [ ] STATE.md updated with PR/MR link
- [ ] Optionally synced PR/MR link to ticket system
</success_criteria>
